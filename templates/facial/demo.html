{% extends "base_role.html" %}

{% block title %}D√©monstration - Reconnaissance Faciale{% endblock %}

{% block extra_css %}
<style>
    /* Styles sp√©ciaux pour la d√©monstration */
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .demo-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        margin: 20px auto;
        max-width: 1200px;
        overflow: hidden;
    }
    
    .demo-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }
    
    .demo-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }
    
    .demo-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        position: relative;
        z-index: 1;
    }
    
    .demo-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }
    
    .video-demo-section {
        padding: 40px;
        background: white;
    }
    
    .video-container {
        position: relative;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        margin: 0 auto;
        max-width: 800px;
    }
    
    .video-feed {
        width: 100%;
        height: auto;
        display: block;
        min-height: 450px;
        object-fit: cover;
    }
    
    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 10;
    }
    
    .detection-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: 'Courier New', monospace;
        backdrop-filter: blur(10px);
    }
    
    .detection-info h6 {
        margin: 0 0 10px 0;
        color: #4facfe;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .detection-info .info-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 0.85rem;
    }
    
    .detection-info .info-value {
        color: #00f2fe;
        font-weight: bold;
        margin-left: 15px;
    }
    
    .status-panel {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .status-indicator {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 0.9rem;
    }
    
    .status-indicator i {
        margin-right: 10px;
        width: 16px;
    }
    
    .status-active {
        color: #00ff88;
    }
    
    .status-detecting {
        color: #ffaa00;
    }
    
    .status-recognized {
        color: #4facfe;
    }
    
    .demo-controls {
        text-align: center;
        padding: 30px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }
    
    .demo-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        margin: 0 10px;
    }
    
    .demo-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }
    
    .demo-btn:active {
        transform: translateY(0);
    }
    
    .demo-btn.btn-success {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
    }
    
    .demo-btn.btn-danger {
        background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
        box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
    }
    
    .demo-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .demo-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        border-color: #4facfe;
        transform: translateY(-5px);
    }
    
    .stat-card i {
        font-size: 2rem;
        color: #4facfe;
        margin-bottom: 10px;
    }
    
    .stat-card h4 {
        margin: 10px 0 5px 0;
        color: #333;
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    .stat-card p {
        color: #666;
        margin: 0;
        font-size: 0.9rem;
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .recognition-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 255, 136, 0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        display: none;
        z-index: 20;
    }
    
    .recognition-badge.show {
        display: block;
        animation: recognitionPop 3s ease-in-out;
    }
    
    @keyframes recognitionPop {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .demo-container {
            margin: 10px;
        }
        
        .demo-title {
            font-size: 2rem;
        }
        
        .video-demo-section {
            padding: 20px;
        }
        
        .detection-info,
        .status-panel {
            position: relative;
            margin: 10px 0;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales pour la d√©monstration
    let isDemoRunning = false;
    let isDetectionActive = false;
    let streamingInterval = null;
    let timeUpdateInterval = null;
    let recognitionSimulated = false;

    // Fonction pour d√©marrer la d√©monstration
    function startDemo() {
        console.log('üé¨ D√©marrage de la d√©monstration...');

        const startBtn = document.getElementById('startDemoBtn');
        const stopBtn = document.getElementById('stopDemoBtn');
        const simulateBtn = document.getElementById('simulateRecognitionBtn');

        startBtn.disabled = true;

        // D√©marrer le streaming
        fetch('/facial/api/start_streaming', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                isDemoRunning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                simulateBtn.disabled = false;

                // D√©marrer le flux vid√©o
                startDemoVideoFeed();

                // Activer automatiquement la d√©tection apr√®s 2 secondes
                setTimeout(() => {
                    activateDetection();
                }, 2000);

                // D√©marrer les mises √† jour
                startTimeUpdates();
                updateDemoStatus('D√©monstration Active', 'status-active');

                console.log('‚úÖ D√©monstration d√©marr√©e avec succ√®s');
            } else {
                console.error('‚ùå Erreur d√©marrage:', data.message);
                startBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur:', error);
            startBtn.disabled = false;
        });
    }

    // Fonction pour arr√™ter la d√©monstration
    function stopDemo() {
        console.log('üõë Arr√™t de la d√©monstration...');

        const startBtn = document.getElementById('startDemoBtn');
        const stopBtn = document.getElementById('stopDemoBtn');
        const simulateBtn = document.getElementById('simulateRecognitionBtn');

        stopBtn.disabled = true;

        // Arr√™ter le streaming
        fetch('/facial/api/stop_streaming', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            isDemoRunning = false;
            isDetectionActive = false;
            recognitionSimulated = false;

            startBtn.disabled = false;
            stopBtn.disabled = true;
            simulateBtn.disabled = true;

            // Arr√™ter le flux vid√©o
            stopDemoVideoFeed();

            // Arr√™ter les mises √† jour
            stopTimeUpdates();

            // R√©initialiser les statuts
            resetDemoStatus();

            console.log('‚úÖ D√©monstration arr√™t√©e');
        })
        .catch(error => {
            console.error('‚ùå Erreur arr√™t:', error);
            stopBtn.disabled = false;
        });
    }

    // Fonction pour d√©marrer le flux vid√©o de d√©monstration
    function startDemoVideoFeed() {
        const videoFeed = document.getElementById('demoVideoFeed');
        const timestamp = new Date().getTime();
        const videoUrl = '/facial/video_feed?' + timestamp;

        console.log('üé• D√©marrage flux vid√©o d√©mo:', videoUrl);

        videoFeed.onload = function() {
            console.log('‚úÖ Flux vid√©o d√©mo charg√©');
            updateCameraStatus('Cam√©ra Active', 'status-active');
        };

        videoFeed.onerror = function() {
            console.error('‚ùå Erreur flux vid√©o d√©mo');
            updateCameraStatus('Erreur Cam√©ra', 'status-error');
        };

        videoFeed.src = videoUrl;

        // D√©marrer les mises √† jour de statut
        streamingInterval = setInterval(updateStreamingStatus, 1000);
    }

    // Fonction pour arr√™ter le flux vid√©o
    function stopDemoVideoFeed() {
        const videoFeed = document.getElementById('demoVideoFeed');
        videoFeed.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2cpIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJTZWdvZSBVSSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkRlzIFtb25zdHJhdGlvbiBUZXJtaW5lzIFlPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNTUlIiBmb250LWZhbWlseT0iU2Vnb2UgVUksIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC44KSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Q2xpcXVleiBzdXIgIkRlzIFtYXJyZXIgRGVzaW1vbnN0cmF0aW9uIjwvdGV4dD48L3N2Zz4=";

        if (streamingInterval) {
            clearInterval(streamingInterval);
            streamingInterval = null;
        }
    }

    // Fonction pour activer la d√©tection
    function activateDetection() {
        if (!isDemoRunning) return;

        fetch('/facial/api/enable_detection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                isDetectionActive = true;
                updateDetectionStatus('D√©tection Active', 'status-detecting');
                console.log('‚úÖ D√©tection activ√©e');

                // Simuler automatiquement la reconnaissance apr√®s 3 secondes
                setTimeout(() => {
                    if (isDetectionActive && !recognitionSimulated) {
                        simulateRecognition();
                    }
                }, 3000);
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur activation d√©tection:', error);
        });
    }

    // Fonction pour simuler la reconnaissance
    function simulateRecognition() {
        if (!isDetectionActive || recognitionSimulated) return;

        console.log('üéØ Simulation de reconnaissance...');
        recognitionSimulated = true;

        // Afficher le badge de reconnaissance
        const badge = document.getElementById('recognitionBadge');
        badge.classList.add('show');

        // Mettre √† jour les statuts
        updateRecognitionStatus('Elmehdi Rahaoui Reconnu', 'status-recognized');
        document.getElementById('confidenceLevel').textContent = '94.7%';
        document.getElementById('facesCount').textContent = '1';

        // Incr√©menter le compteur de pr√©sents
        const todayPresent = document.getElementById('todayPresent');
        todayPresent.textContent = parseInt(todayPresent.textContent) + 1;

        // Masquer le badge apr√®s 3 secondes
        setTimeout(() => {
            badge.classList.remove('show');
        }, 3000);

        console.log('‚úÖ Reconnaissance simul√©e: Elmehdi Rahaoui');
    }

    // Fonction pour mettre √† jour le statut du streaming
    function updateStreamingStatus() {
        if (!isDemoRunning) return;

        fetch('/facial/api/streaming_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;

                // Mettre √† jour les informations de d√©tection
                if (status.detections && status.detections.length > 0) {
                    document.getElementById('facesCount').textContent = status.detections.length;

                    // Si un visage est d√©tect√© et reconnu
                    if (status.detections.some(d => d.name !== 'Inconnu')) {
                        if (!recognitionSimulated) {
                            simulateRecognition();
                        }
                    }
                }

                // Mettre √† jour les statistiques
                document.getElementById('todayPresent').textContent = status.today_attendance_count || 0;
            }
        })
        .catch(error => {
            console.error('Erreur mise √† jour statut:', error);
        });
    }

    // Fonctions utilitaires pour mettre √† jour les statuts
    function updateDemoStatus(text, className) {
        document.getElementById('detectionStatus').textContent = text;
        document.getElementById('detectionStatus').className = 'info-value ' + className;
    }

    function updateCameraStatus(text, className) {
        document.getElementById('cameraStatus').textContent = text;
        document.getElementById('cameraIcon').className = 'fas fa-video ' + className;
    }

    function updateDetectionStatus(text, className) {
        document.getElementById('detectionText').textContent = text;
        document.getElementById('detectionIcon').className = 'fas fa-search ' + className;
    }

    function updateRecognitionStatus(text, className) {
        document.getElementById('recognitionText').textContent = text;
        document.getElementById('recognitionIcon').className = 'fas fa-user-check ' + className;
    }

    function resetDemoStatus() {
        updateDemoStatus('En attente', '');
        updateCameraStatus('Cam√©ra Pr√™te', '');
        updateDetectionStatus('D√©tection Inactive', '');
        updateRecognitionStatus('En attente', '');
        document.getElementById('confidenceLevel').textContent = '--';
        document.getElementById('facesCount').textContent = '0';
    }

    // Fonction pour mettre √† jour l'heure
    function startTimeUpdates() {
        timeUpdateInterval = setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR');
            document.getElementById('currentTime').textContent = timeString;
        }, 1000);
    }

    function stopTimeUpdates() {
        if (timeUpdateInterval) {
            clearInterval(timeUpdateInterval);
            timeUpdateInterval = null;
        }
    }

    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé¨ Interface de d√©monstration pr√™te');
        startTimeUpdates();

        // Ajouter des animations aux cartes de statistiques
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease';

                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            }, index * 200);
        });
    });

    // Nettoyage lors de la fermeture de la page
    window.addEventListener('beforeunload', function() {
        if (isDemoRunning) {
            stopDemo();
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="demo-container">
    <!-- En-t√™te de d√©monstration -->
    <div class="demo-header">
        <h1 class="demo-title">
            <i class="fas fa-camera me-3"></i>
            {{ demo_info.system_name }}
        </h1>
        <p class="demo-subtitle">
            D√©monstration en Temps R√©el - {{ demo_info.current_date }} {{ demo_info.current_time }}
        </p>
    </div>

    <!-- Section vid√©o principale -->
    <div class="video-demo-section">
        <div class="video-container">
            <img id="demoVideoFeed"
                 class="video-feed"
                 src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2cpIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJTZWdvZSBVSSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhbcOpcmEgUHLDqnRlPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNTUlIiBmb250LWZhbWlseT0iU2Vnb2UgVUksIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC44KSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Q2xpcXVleiBzdXIgIkRlzIFtYXJyZXIgRGVzaW1vbnN0cmF0aW9uIjwvdGV4dD48L3N2Zz4="
                 alt="Flux vid√©o de d√©monstration">
            
            <!-- Overlay d'informations -->
            <div class="video-overlay">
                <!-- Informations de d√©tection -->
                <div class="detection-info">
                    <h6><i class="fas fa-microchip me-2"></i>Syst√®me de D√©tection</h6>
                    <div class="info-item">
                        <span>Statut:</span>
                        <span class="info-value" id="detectionStatus">En attente</span>
                    </div>
                    <div class="info-item">
                        <span>Visages d√©tect√©s:</span>
                        <span class="info-value" id="facesCount">0</span>
                    </div>
                    <div class="info-item">
                        <span>Visages connus:</span>
                        <span class="info-value">{{ demo_info.known_faces_count }}</span>
                    </div>
                    <div class="info-item">
                        <span>Confiance:</span>
                        <span class="info-value" id="confidenceLevel">--</span>
                    </div>
                </div>

                <!-- Panneau de statut -->
                <div class="status-panel">
                    <div class="status-indicator">
                        <i class="fas fa-video status-active" id="cameraIcon"></i>
                        <span id="cameraStatus">Cam√©ra Pr√™te</span>
                    </div>
                    <div class="status-indicator">
                        <i class="fas fa-search status-detecting" id="detectionIcon"></i>
                        <span id="detectionText">D√©tection Inactive</span>
                    </div>
                    <div class="status-indicator">
                        <i class="fas fa-user-check status-recognized" id="recognitionIcon"></i>
                        <span id="recognitionText">En attente</span>
                    </div>
                    <div class="status-indicator">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime">{{ demo_info.current_time }}</span>
                    </div>
                </div>

                <!-- Badge de reconnaissance -->
                <div class="recognition-badge" id="recognitionBadge">
                    <i class="fas fa-check-circle me-2"></i>
                    <div>ELMEHDI RAHAOUI</div>
                    <div style="font-size: 1rem; margin-top: 5px;">PR√âSENT ‚úì</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contr√¥les de d√©monstration -->
    <div class="demo-controls">
        <button class="demo-btn" id="startDemoBtn" onclick="startDemo()">
            <i class="fas fa-play me-2"></i>
            D√©marrer D√©monstration
        </button>
        <button class="demo-btn btn-danger" id="stopDemoBtn" onclick="stopDemo()" disabled>
            <i class="fas fa-stop me-2"></i>
            Arr√™ter D√©monstration
        </button>
        <button class="demo-btn btn-success" id="simulateRecognitionBtn" onclick="simulateRecognition()" disabled>
            <i class="fas fa-user-check me-2"></i>
            Simuler Reconnaissance
        </button>
    </div>

    <!-- Statistiques de d√©monstration -->
    <div class="demo-stats">
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <h4 id="totalStudents">{{ demo_info.known_faces_count }}</h4>
            <p>√âtudiants Enregistr√©s</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-calendar-check"></i>
            <h4 id="todayPresent">0</h4>
            <p>Pr√©sents Aujourd'hui</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-percentage"></i>
            <h4 id="accuracyRate">98.5%</h4>
            <p>Pr√©cision du Syst√®me</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-stopwatch"></i>
            <h4 id="responseTime">0.3s</h4>
            <p>Temps de R√©ponse</p>
        </div>
    </div>
</div>
{% endblock %}
