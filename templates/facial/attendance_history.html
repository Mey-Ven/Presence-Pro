{% extends "base_role.html" %}

{% block title %}Historique des Présences - Reconnaissance Faciale{% endblock %}

{% block page_title %}Historique des Présences par IA{% endblock %}

{% block extra_css %}
<style>
    .history-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .attendance-row {
        background: white;
        border-left: 4px solid #28a745;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .attendance-row:hover {
        transform: translateX(5px);
    }
    
    .confidence-bar {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
        transition: width 0.3s ease;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Filtres -->
    <div class="filter-card">
        <h4 class="mb-3">
            <i class="fas fa-filter me-2"></i>
            Filtres de Recherche
        </h4>
        
        <form method="GET" action="{{ url_for('facial.attendance_history') }}">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Date de début</label>
                    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date de fin</label>
                    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Étudiant</label>
                    <select class="form-select" name="student_id">
                        <option value="">Tous les étudiants</option>
                        {% for student in students %}
                        <option value="{{ student.id }}" {{ 'selected' if student.id == selected_student_id else '' }}>
                            {{ student.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-light w-100">
                        <i class="fas fa-search me-2"></i>
                        Filtrer
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Statistiques rapides -->
        <div class="stats-grid mt-4">
            <div class="stat-item">
                <div class="h4">{{ attendance_records|length }}</div>
                <small>Enregistrements</small>
            </div>
            <div class="stat-item">
                <div class="h4">{{ attendance_records|map(attribute='student_id')|unique|list|length }}</div>
                <small>Étudiants Uniques</small>
            </div>
            <div class="stat-item">
                <div class="h4">
                    {% if attendance_records %}
                        {{ "%.1f"|format((attendance_records|map(attribute='confidence')|select|sum / attendance_records|map(attribute='confidence')|select|list|length) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <small>Confiance Moyenne</small>
            </div>
            <div class="stat-item">
                <div class="h4">{{ attendance_records|map(attribute='date')|unique|list|length }}</div>
                <small>Jours Différents</small>
            </div>
        </div>
    </div>

    <!-- Historique des présences -->
    <div class="history-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>
                Historique des Détections
            </h5>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync me-1"></i>
                    Actualiser
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>
                    Exporter
                </button>
            </div>
        </div>

        {% if attendance_records %}
            <div id="attendanceList" style="max-height: 600px; overflow-y: auto;">
                {% for record in attendance_records %}
                <div class="attendance-row">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1">{{ record.student_name }}</h6>
                            <small class="text-muted">ID: {{ record.student_id }}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="fw-bold text-primary">{{ record.date }}</div>
                                <small class="text-muted">{{ record.time }}</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>
                                {{ record.status }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            {% if record.confidence %}
                            <div class="d-flex align-items-center">
                                <small class="me-2">Confiance:</small>
                                <div class="flex-grow-1">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: {{ (record.confidence * 100)|round }}%"></div>
                                    </div>
                                </div>
                                <small class="ms-2">{{ "%.1f"|format(record.confidence * 100) }}%</small>
                            </div>
                            {% else %}
                            <small class="text-muted">Confiance non disponible</small>
                            {% endif %}
                        </div>
                        <div class="col-md-2 text-end">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {{ record.created_at[:19] if record.created_at else '-' }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination info -->
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Affichage de {{ attendance_records|length }} enregistrements
                    {% if attendance_records|length == 100 %}
                    (limité à 100 résultats - utilisez les filtres pour affiner)
                    {% endif %}
                </small>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Aucune présence trouvée</h5>
                <p class="text-muted">
                    {% if start_date or end_date or selected_student_id %}
                        Aucun enregistrement ne correspond aux critères de recherche.
                        <br>Essayez de modifier vos filtres.
                    {% else %}
                        Aucune présence n'a encore été détectée par reconnaissance faciale.
                        <br>Les détections apparaîtront ici automatiquement.
                    {% endif %}
                </p>
                {% if start_date or end_date or selected_student_id %}
                <a href="{{ url_for('facial.attendance_history') }}" class="btn btn-outline-primary">
                    <i class="fas fa-times me-2"></i>
                    Effacer les Filtres
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Zone de statut -->
    <div class="alert alert-info" id="statusAlert" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" id="statusSpinner" style="display: none;"></div>
            <span id="statusMessage">Prêt</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showStatus(message, type = 'info', showSpinner = false) {
        const alert = document.getElementById('statusAlert');
        const spinner = document.getElementById('statusSpinner');
        const messageEl = document.getElementById('statusMessage');
        
        alert.className = `alert alert-${type}`;
        alert.style.display = 'block';
        messageEl.textContent = message;
        spinner.style.display = showSpinner ? 'inline-block' : 'none';
    }

    function refreshData() {
        showStatus('Actualisation des données...', 'info', true);
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    function exportData() {
        showStatus('Préparation de l\'export...', 'info', true);
        
        // Créer un CSV simple des données affichées
        const records = {{ attendance_records|tojson }};
        
        if (records.length === 0) {
            showStatus('Aucune donnée à exporter', 'warning');
            return;
        }
        
        let csv = 'Date,Heure,Étudiant,Statut,Confiance,Horodatage\n';
        
        records.forEach(record => {
            csv += `"${record.date}","${record.time}","${record.student_name}","${record.status}","${record.confidence ? (record.confidence * 100).toFixed(1) + '%' : 'N/A'}","${record.created_at || 'N/A'}"\n`;
        });
        
        // Télécharger le fichier
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `presences_ia_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus('Export terminé avec succès', 'success');
    }

    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (!startDateInput.value) {
            startDateInput.value = today;
        }
        if (!endDateInput.value) {
            endDateInput.value = today;
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Définir la date d'aujourd'hui par défaut si aucune date n'est sélectionnée
        if (!{{ 'true' if start_date or end_date else 'false' }}) {
            setTodayDate();
        }
        
        showStatus('{{ attendance_records|length }} enregistrements chargés', 'info');
        
        // Auto-actualisation toutes les 30 secondes si on affiche aujourd'hui
        const today = new Date().toISOString().split('T')[0];
        const startDate = '{{ start_date }}';
        const endDate = '{{ end_date }}';
        
        if ((!startDate && !endDate) || (startDate === today && endDate === today)) {
            setInterval(refreshData, 30000);
        }
    });
</script>
{% endblock %}
